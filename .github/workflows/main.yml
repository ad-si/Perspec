name: Haskell Stack CI

on: [push]

jobs:
  macos:
    strategy:
      matrix:
        include:
          - os: macos-14
            arch: arm64
          - os: macos-15
            arch: arm64
          - os: macos-15-intel
            arch: x86_64
          - os: macos-26
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-no-global: true

      - name: Install Platypus
        run: |
          curl -L -O https://github.com/sveinbjornt/Platypus/releases/download/v5.5.0/platypus5.5.0.zip
          unzip -q platypus5.5.0.zip
          cd Platypus.app/Contents/Resources
          sudo bash InstallCommandLineTool.sh

      - name: Print Platypus' version
        run: platypus --version

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Inject license keys
        run:
          sed -i ''
            's/licenses = \[\]/licenses = \[${{ secrets.LICENSE_KEYS }}\]/'
            source/Lib.hs

      - name: Build Perspec App
        run: make Perspec.app

      - name: Move App to Artifact Directory
        run: mkdir artifact && mv Perspec.app artifact

      - name: Upload MacOS Release
        uses: actions/upload-artifact@v4
        with:
          path: artifact
          name: perspec-app_${{ matrix.os }}_${{ matrix.arch }}

  linux:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-no-global: true

      - name: Add apt repository for libfuse2
        run:
          sudo add-apt-repository universe

      - name: Install dependencies
        run:
          sudo apt-get install
            imagemagick
            libblas-dev
            libblas3
            libfuse2
            libgl1-mesa-dev
            libglfw3
            libglu1-mesa-dev
            liblapack-dev
            liblapack3
            libxcursor-dev
            libxi-dev
            libxinerama-dev
            libxrandr-dev
            libxxf86vm-dev

      - name: Download bundable ImageMagick binary and install globally
        run: |
          if test "${{ matrix.arch }}" = "x86_64"
          then
            curl -L -O https://imagemagick.org/archive/binaries/magick \
              && chmod +x ./magick
            sudo cp ./magick /usr/local/bin/magick
          else
            # For arm64, symlink the system ImageMagick
            sudo ln -sf $(which magick || which convert) /usr/local/bin/magick
          fi

      - name: Build Perspec CLI tool
        run: make perspec

      - name: Install AppImage
        run: |
          LINUX_ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || matrix.arch }}
          curl -L -O https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${LINUX_ARCH}.AppImage
          chmod +x linuxdeploy-${LINUX_ARCH}.AppImage
          mv linuxdeploy-${LINUX_ARCH}.AppImage linuxdeploy-${{ matrix.arch }}.AppImage

      - name: Build AppImage
        run: |
          LINUX_ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || matrix.arch }}
          ./linuxdeploy-${{ matrix.arch }}.AppImage \
            --executable $(which perspec) \
            --library /usr/lib/${LINUX_ARCH}-linux-gnu/libglfw.so.3 \
            --appdir ./AppDir \
            --output appimage \
            --desktop-file ./perspec.desktop \
            --icon-file $(pwd)/images/icon_padded_white_512.png
          mv Perspec-${LINUX_ARCH}.AppImage Perspec_${{ matrix.arch }}.AppImage

      - name: Upload Linux Release
        uses: actions/upload-artifact@v4
        with:
          path: ./Perspec_${{ matrix.arch }}.AppImage
          name: Perspec_${{ matrix.arch }}.AppImage
