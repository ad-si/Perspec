name: Haskell Stack CI

on: [push]

jobs:
  macos:
    strategy:
      matrix:
        include:
          - os: macos-14
            arch: arm64
          - os: macos-15
            arch: arm64
          - os: macos-15-intel
            arch: x86_64
          - os: macos-26
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.stack
            .stack-work
          key: ${{ runner.os }}-${{ matrix.arch }}-stack-${{ hashFiles('stack.yaml', 'stack.yaml.lock', 'package.yaml') }}

      - name: Setup Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-no-global: true

      - name: Install Platypus
        run: |
          curl -L -O https://github.com/sveinbjornt/Platypus/releases/download/v5.5.0/platypus5.5.0.zip
          unzip -q platypus5.5.0.zip
          cd Platypus.app/Contents/Resources
          sudo bash InstallCommandLineTool.sh

      - name: Print Platypus' version
        run: platypus --version

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Inject license keys
        run:
          sed -i ''
            's/licenses = \[\]/licenses = \[${{ secrets.LICENSE_KEYS }}\]/'
            source/Lib.hs

      - name: Build Perspec App
        run: make Perspec.app
        env:
          GHCRTS: -K64M
          STACK_OPTS: --ghc-options=-O2

      - name: Move App to Artifact Directory
        run: mkdir artifact && mv Perspec.app artifact

      - name: Upload MacOS Release
        uses: actions/upload-artifact@v4
        with:
          path: artifact
          name: perspec-app_${{ matrix.os }}_${{ matrix.arch }}

  linux:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.stack
            .stack-work
          key: ${{ runner.os }}-${{ matrix.arch }}-stack-${{ hashFiles('stack.yaml', 'stack.yaml.lock', 'package.yaml') }}

      - name: Setup Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-no-global: true

      - name: Add apt repository for libfuse2
        run:
          sudo add-apt-repository universe

      - name: Install dependencies
        run:
          sudo apt-get install
            imagemagick
            libblas-dev
            libblas3
            libfuse2
            libgl1-mesa-dev
            libglfw3
            libglu1-mesa-dev
            liblapack-dev
            liblapack3
            libwebp-dev
            libxcursor-dev
            libxi-dev
            libxinerama-dev
            libxrandr-dev
            libxxf86vm-dev

      - name: Download bundable ImageMagick binary and install globally
        run: |
          if test "${{ matrix.arch }}" = "x86_64"
          then
            curl -L -O https://imagemagick.org/archive/binaries/magick \
              && chmod +x ./magick
            sudo cp ./magick /usr/local/bin/magick
          else
            # For arm64, symlink the system ImageMagick
            sudo ln -sf $(which magick || which convert) /usr/local/bin/magick
          fi

      - name: Build Perspec CLI tool
        run: make perspec
        env:
          GHCRTS: -K64M
          STACK_OPTS: --ghc-options=-O2

      - name: Install AppImage
        run: |
          LINUX_ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || matrix.arch }}
          curl -L -O https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${LINUX_ARCH}.AppImage
          chmod +x linuxdeploy-${LINUX_ARCH}.AppImage
          if test "${LINUX_ARCH}" != "${{ matrix.arch }}"
          then mv linuxdeploy-${LINUX_ARCH}.AppImage linuxdeploy-${{ matrix.arch }}.AppImage
          fi

      - name: Build AppImage
        run: |
          LINUX_ARCH=${{ matrix.arch == 'arm64' && 'aarch64' || matrix.arch }}
          cp images/icon_padded_white_512.png perspec.png
          ./linuxdeploy-${{ matrix.arch }}.AppImage \
            --executable $(which perspec) \
            --library /usr/lib/${LINUX_ARCH}-linux-gnu/libglfw.so.3 \
            --appdir ./AppDir \
            --output appimage \
            --desktop-file ./perspec.desktop \
            --icon-file ./perspec.png \
            --custom-apprun ./AppRun
          mv Perspec-${LINUX_ARCH}.AppImage Perspec_${{ matrix.arch }}.AppImage

      - name: Upload Linux Release
        uses: actions/upload-artifact@v4
        with:
          path: ./Perspec_${{ matrix.arch }}.AppImage
          name: Perspec_${{ matrix.arch }}.AppImage

  windows:
    # ARM64 Windows is blocked on ghcup support:
    # https://github.com/haskell/ghcup-hs/issues/1034
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Roaming\stack
            .stack-work
          key: ${{ runner.os }}-x86_64-stack-${{ hashFiles('stack.yaml', 'stack.yaml.lock', 'package.yaml') }}

      - name: Setup Stack
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-no-global: true

      - name: Install MSYS2 dependencies
        run:
          stack exec -- pacman -S --noconfirm
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-glfw
            mingw-w64-x86_64-openblas
            mingw-w64-x86_64-libwebp

      - name: Install ImageMagick
        run: choco install imagemagick -y

      - name: Build banner.bmp
        run: magick images\banner.png images\banner.bmp

      - name: Inject license keys
        shell: pwsh
        run:
          (Get-Content source\Lib.hs -Raw)
            -replace 'licenses = \[\]', 'licenses = [${{ secrets.LICENSE_KEYS }}]'
          | Set-Content -NoNewline source\Lib.hs

      - name: Build Perspec
        run: stack install --ghc-options=-O2 --flag hmatrix:openblas
        env:
          GHCRTS: -K64M

      - name: Prepare artifact
        shell: pwsh
        run: |
          mkdir artifact
          $binPath = (stack path --local-bin).Trim()
          Copy-Item "$binPath\perspec.exe" artifact\

          # Copy all non-system DLLs that perspec.exe depends on
          $msysRoot = stack exec -- bash -c 'echo $MINGW_PREFIX'
          $msysBin = "$msysRoot/bin"
          $lddOutput = stack exec -- ldd "$binPath\perspec.exe"
          $lddOutput | ForEach-Object {
            if ($_ -match '^\s*(\S+\.dll)\s+=>\s+(/\S+)') {
              $dllName = $Matches[1]
              $dllPath = $Matches[2]
              # Skip Windows system DLLs
              if ($dllPath -like "$msysRoot/*") {
                $winPath = stack exec -- cygpath -w $dllPath
                Write-Host "Bundling $dllName from $winPath"
                Copy-Item $winPath artifact\
              }
            }
          }

      - name: Upload Windows Release
        uses: actions/upload-artifact@v4
        with:
          path: artifact
          name: perspec-windows_x86_64
